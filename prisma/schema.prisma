generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  name              String?
  bio               String?
  avatar            String?
  role              UserRole  @default(SPECTATOR)
  tradingStyle      String?
  sessionPreference String?
  preferredPairs    String[]
  emailVerified     DateTime?
  verifyToken       String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  isPro             Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  statements        TradingStatement[]
  traderStatements  TraderStatement[]  @relation("TraderStatements")
  clanMemberships   ClanMember[]
  createdClans    Clan[]        @relation("ClanCreator")
  followsGiven    Follow[]      @relation("Follower")
  stories         Story[]
  channelPosts    ChannelPost[]
  messages        Message[]
  createdTopics   ChatTopic[]
  trades          Trade[]
  watchlists      Watchlist[]
  joinRequests        ClanJoinRequest[]  @relation("JoinRequestUser")
  reviewedJoinRequests ClanJoinRequest[] @relation("JoinRequestReviewer")
  dmConversations1    Conversation[]     @relation("ConversationParticipant1")
  dmConversations2    Conversation[]     @relation("ConversationParticipant2")
  sentDirectMessages  DirectMessage[]    @relation("DirectMessageSender")
  badges              UserBadge[]
  badgeAdminChanges   BadgeAdminChange[] @relation("BadgeAdminChanges")

  @@index([email])
}

enum UserRole {
  SPECTATOR
  TRADER
  ADMIN
}

model TradingStatement {
  id                 String             @id @default(cuid())
  userId             String
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  filePath           String
  originalFilename   String
  verificationStatus VerificationStatus @default(PENDING)
  verificationMethod VerificationMethod @default(SELF_REPORTED)
  extractedMetrics   Json?
  reviewNotes        String?
  uploadedAt         DateTime           @default(now())
  verifiedAt         DateTime?
  expiresAt          DateTime?

  @@index([userId])
  @@index([verificationStatus])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum VerificationMethod {
  SELF_REPORTED
  BROKER_VERIFIED
}

model Clan {
  id                 String   @id @default(cuid())
  name               String   @unique
  description        String?
  avatar             String?
  tradingFocus       String?
  isPublic           Boolean  @default(true)
  tier               ClanTier @default(FREE)
  settings           Json?
  isFeatured         Boolean  @default(false)
  adminNotes         String?
  visibilityOverride String?
  createdById        String
  createdBy          User     @relation("ClanCreator", fields: [createdById], references: [id])
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  members           ClanMember[]
  messages          Message[]
  channelPosts      ChannelPost[]
  inviteLinks       ClanInvite[]
  topics            ChatTopic[]
  trades            Trade[]
  watchlists        Watchlist[]
  traderStatements  TraderStatement[]
  joinRequests      ClanJoinRequest[]

  @@index([name])
}

enum ClanTier {
  FREE
  PRO
}

model ClanMember {
  id       String         @id @default(cuid())
  userId   String
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  clanId   String
  clan     Clan           @relation(fields: [clanId], references: [id], onDelete: Cascade)
  role       ClanMemberRole @default(MEMBER)
  joinedAt   DateTime       @default(now())
  lastReadAt DateTime?

  @@unique([userId, clanId])
  @@index([clanId])
}

enum ClanMemberRole {
  LEADER
  CO_LEADER
  MEMBER
}

model ClanInvite {
  id        String    @id @default(cuid())
  clanId    String
  clan      Clan      @relation(fields: [clanId], references: [id], onDelete: Cascade)
  code      String    @unique
  expiresAt DateTime?
  maxUses   Int?
  uses      Int       @default(0)
  createdAt DateTime  @default(now())

  @@index([code])
}

model Follow {
  id            String     @id @default(cuid())
  followerId    String
  follower      User       @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingType FollowType
  followingId   String
  createdAt     DateTime   @default(now())
  lastReadAt    DateTime?

  @@unique([followerId, followingType, followingId])
  @@index([followingType, followingId])
}

enum FollowType {
  USER
  CLAN
}

model Season {
  id        String       @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  status    SeasonStatus @default(UPCOMING)
  createdAt DateTime     @default(now())

  leaderboardEntries LeaderboardEntry[]
  traderStatements   TraderStatement[]

  @@index([status])
}

enum SeasonStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  ARCHIVED
}

model LeaderboardEntry {
  id         String          @id @default(cuid())
  seasonId   String
  season     Season          @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  entityType LeaderboardType
  entityId   String
  lens       String          @default("composite")
  rank       Int?
  metrics    Json
  updatedAt  DateTime        @updatedAt

  @@unique([seasonId, entityType, entityId, lens])
  @@index([seasonId, entityType, rank])
}

model RankingConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  lenses    Json
  weights   Json
  minTrades Int      @default(10)
  updatedAt DateTime @updatedAt
}

enum LeaderboardType {
  TRADER
  CLAN
}

// --- Chat & Topics ---

enum MessageType {
  TEXT
  TRADE_CARD
  SYSTEM_SUMMARY
  TRADE_ACTION
}

enum TradeActionType {
  SET_BE
  MOVE_SL
  CHANGE_TP
  CLOSE
  ADD_NOTE
  STATUS_CHANGE
  INTEGRITY_FLAG
  MANUAL_STATUS_SET
  ADMIN_STATEMENT_TOGGLE
}

enum TradeDirection {
  LONG
  SHORT
}

enum TradeStatus {
  PENDING
  OPEN
  TP_HIT
  TP1_HIT // @deprecated — kept for PostgreSQL compat, never used in code
  TP2_HIT // @deprecated — kept for PostgreSQL compat, never used in code
  SL_HIT
  BE
  CLOSED
  UNVERIFIED
}

enum IntegrityStatus {
  VERIFIED
  UNVERIFIED
}

enum IntegrityReason {
  ENTRY_CONFLICT
  EXIT_CONFLICT
  DATA_GAP
  MANUAL_OVERRIDE
  OTHER
}

enum ResolutionSource {
  EVALUATOR
  MANUAL
  UNKNOWN
}

enum TopicStatus {
  ACTIVE
  ARCHIVED
}

model ChatTopic {
  id          String      @id @default(cuid())
  clanId      String
  clan        Clan        @relation(fields: [clanId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isDefault   Boolean     @default(false)
  status      TopicStatus @default(ACTIVE)
  sortOrder   Int         @default(0)
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  messages Message[]

  @@unique([clanId, name])
  @@index([clanId, status])
}

model Message {
  id        String      @id @default(cuid())
  clanId    String
  clan      Clan        @relation(fields: [clanId], references: [id], onDelete: Cascade)
  topicId   String?
  topic     ChatTopic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  type      MessageType @default(TEXT)
  isPinned  Boolean     @default(false)
  isEdited  Boolean     @default(false)
  reactions Json?
  replyToId String?
  replyTo   Message?    @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[]   @relation("MessageReplies")
  images    String[]
  createdAt DateTime    @default(now())

  tradeCard TradeCard?

  @@index([clanId, createdAt])
  @@index([topicId, createdAt])
}

model TradeCard {
  id        String         @id @default(cuid())
  messageId String         @unique
  message   Message        @relation(fields: [messageId], references: [id], onDelete: Cascade)
  instrument String
  direction TradeDirection
  entry     Float
  stopLoss  Float
  targets   Float[]
  timeframe String
  riskPct   Float?
  note      String?
  tags      String[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  versions    TradeCardVersion[]
  trade       Trade?
  channelPost ChannelPost?

  @@index([instrument])
  @@index([direction])
}

model TradeCardVersion {
  id          String         @id @default(cuid())
  tradeCardId String
  tradeCard   TradeCard      @relation(fields: [tradeCardId], references: [id], onDelete: Cascade)
  instrument  String
  direction   TradeDirection
  entry       Float
  stopLoss    Float
  targets     Float[]
  timeframe   String
  riskPct     Float?
  note        String?
  tags        String[]
  editedById  String
  editedAt    DateTime       @default(now())

  @@index([tradeCardId, editedAt])
}

model Trade {
  id          String      @id @default(cuid())
  tradeCardId String      @unique
  tradeCard   TradeCard   @relation(fields: [tradeCardId], references: [id], onDelete: Cascade)
  clanId      String
  clan        Clan        @relation(fields: [clanId], references: [id], onDelete: Cascade)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      TradeStatus @default(PENDING)
  closedAt    DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Trade integrity fields
  entryFilledAt     DateTime?
  lastEvaluatedAt   DateTime?
  integrityStatus   IntegrityStatus  @default(VERIFIED)
  integrityReason   IntegrityReason?
  integrityDetails  Json?
  statementEligible Boolean          @default(true)
  resolutionSource  ResolutionSource @default(UNKNOWN)

  statusHistory TradeStatusHistory[]
  events        TradeEvent[]

  @@index([clanId, status])
  @@index([clanId, createdAt])
  @@index([userId])
  @@index([status, lastEvaluatedAt])
}

model TradeEvent {
  id         String          @id @default(cuid())
  tradeId    String
  trade      Trade           @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  actionType TradeActionType
  actorId    String
  oldValue   String?
  newValue   String?
  note       String?
  createdAt  DateTime        @default(now())

  @@index([tradeId, createdAt])
  @@index([actorId])
}

model TradeStatusHistory {
  id          String      @id @default(cuid())
  tradeId     String
  trade       Trade       @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  fromStatus  TradeStatus
  toStatus    TradeStatus
  changedById String
  note        String?
  createdAt   DateTime    @default(now())

  @@index([tradeId, createdAt])
}

model Watchlist {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clanId     String
  clan       Clan     @relation(fields: [clanId], references: [id], onDelete: Cascade)
  instrument String
  addedAt    DateTime @default(now())

  @@unique([userId, clanId, instrument])
  @@index([userId, clanId])
}

model TradingEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  instrument  String?
  impact      String?
  startTime   DateTime
  endTime     DateTime?
  source      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, startTime])
}

enum ChannelPostSource {
  MANUAL
  AUTO_TAG
}

model ChannelPost {
  id          String            @id @default(cuid())
  clanId      String
  clan        Clan              @relation(fields: [clanId], references: [id], onDelete: Cascade)
  authorId    String
  author      User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  title       String?
  content     String
  images      String[]
  isPremium   Boolean           @default(false)
  viewCount   Int               @default(0)
  reactions   Json?
  tradeCardId String?           @unique
  tradeCard   TradeCard?        @relation(fields: [tradeCardId], references: [id], onDelete: SetNull)
  sourceType  ChannelPostSource @default(MANUAL)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([clanId, createdAt])
  @@index([isPremium])
}

model Story {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  imageUrl    String
  textOverlay String?
  viewCount   Int      @default(0)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([expiresAt])
}

// --- Trader Statements ---

enum StatementPeriod {
  MONTHLY
  SEASONAL
  ALL_TIME
}

model TraderStatement {
  id           String          @id @default(cuid())
  userId       String
  user         User            @relation("TraderStatements", fields: [userId], references: [id], onDelete: Cascade)
  clanId       String
  clan         Clan            @relation(fields: [clanId], references: [id], onDelete: Cascade)
  periodType   StatementPeriod
  periodKey    String
  seasonId     String?
  season       Season?         @relation(fields: [seasonId], references: [id])
  metrics      Json
  tradeCount   Int
  calculatedAt DateTime        @default(now())

  @@unique([userId, clanId, periodType, periodKey])
  @@index([clanId, periodType])
  @@index([userId, periodType])
}

// --- Admin Config ---

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PaywallRule {
  id           String   @id @default(cuid())
  resourceType String   @unique
  name         String
  description  String?
  freePreview  Json?
  enabled      Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SubscriptionPlan {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  price        Float
  currency     String   @default("IRR")
  interval     String   @default("monthly")
  entitlements Json
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  actorId    String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([action, createdAt])
  @@index([actorId])
}

// --- Test Runner ---

enum TestSuite {
  SMOKE
  FULL_E2E
  SIMULATOR
}

enum TestRunMode {
  HEADLESS
  HEADED
}

enum TestRunStatus {
  QUEUED
  CLAIMED
  RUNNING
  PASSED
  FAILED
  CANCELED
}

model TestRun {
  id               String        @id @default(cuid())
  suite            TestSuite
  requestedWorkers Int           @default(2)
  effectiveWorkers Int           @default(2)
  runMode          TestRunMode   @default(HEADLESS)
  status           TestRunStatus @default(QUEUED)
  options          Json?
  queuedById       String
  claimedAt        DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  workerHostname   String?
  totalTests       Int?
  passedTests      Int?
  failedTests      Int?
  skippedTests     Int?
  durationMs       Int?
  reportUrl        String?
  errorMessage     String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([status, createdAt])
  @@index([queuedById])
}

// --- Join Requests ---

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model ClanJoinRequest {
  id           String            @id @default(cuid())
  clanId       String
  clan         Clan              @relation(fields: [clanId], references: [id], onDelete: Cascade)
  userId       String
  user         User              @relation("JoinRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  message      String?
  status       JoinRequestStatus @default(PENDING)
  reviewedById String?
  reviewedBy   User?             @relation("JoinRequestReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  rejectReason String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@unique([clanId, userId])
  @@index([clanId, status])
  @@index([userId])
}

// --- Badges & Ranking ---

enum BadgeCategory {
  RANK
  PERFORMANCE
  TROPHY
  OTHER
}

model BadgeDefinition {
  id               String        @id @default(cuid())
  key              String        @unique
  category         BadgeCategory
  name             String
  description      String?
  iconUrl          String?
  iconAssetKey     String?
  requirementsJson Json
  enabled          Boolean       @default(true)
  displayOrder     Int           @default(0)
  isDeleted        Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  userBadges   UserBadge[]
  adminChanges BadgeAdminChange[]

  @@index([category, enabled])
  @@index([enabled, isDeleted, displayOrder])
}

model UserBadge {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeDefinitionId String
  badgeDefinition   BadgeDefinition @relation(fields: [badgeDefinitionId], references: [id], onDelete: Restrict)
  awardedAt         DateTime        @default(now())
  metadataJson      Json?
  isActive          Boolean         @default(true)
  revokedAt         DateTime?
  evaluatedAt       DateTime        @default(now())

  @@unique([userId, badgeDefinitionId])
  @@index([userId, isActive])
  @@index([badgeDefinitionId])
  @@index([awardedAt])
}

model BadgeAdminChange {
  id                String          @id @default(cuid())
  adminUserId       String
  adminUser         User            @relation("BadgeAdminChanges", fields: [adminUserId], references: [id], onDelete: Cascade)
  badgeDefinitionId String
  badgeDefinition   BadgeDefinition @relation(fields: [badgeDefinitionId], references: [id], onDelete: Cascade)
  changeType        String
  oldValueJson      Json?
  newValueJson      Json?
  createdAt         DateTime        @default(now())

  @@index([badgeDefinitionId, createdAt])
  @@index([adminUserId])
}

// --- Direct Messages ---

model Conversation {
  id             String    @id @default(cuid())
  participant1Id String
  participant1   User      @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2Id String
  participant2   User      @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  lastMessageAt  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  messages DirectMessage[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
}

model DirectMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation("DirectMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  content        String
  isEdited       Boolean      @default(false)
  isRead         Boolean      @default(false)
  replyToId      String?
  replyTo        DirectMessage?  @relation("DmReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies        DirectMessage[] @relation("DmReplies")
  images         String[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([conversationId, createdAt])
  @@index([senderId])
}
